# 羽毛球比赛分组算法规则 (v2.1)

## 核心约束规则

### 1. 基本分组规则
- 每组固定4人
- 每人每轮最多1场比赛
- 连续3轮参赛的玩家必须休息1轮
- 每人总比赛场次不超过设定的最大值（默认6场）

### 2. 搭档次数限制（严格执行）
- **同一搭档组合最多合作2次**
- 违反此规则的分组将被直接拒绝
- 优先级：搭档次数限制 > 性别平衡

### 3. 性别分组规则（严格执行）
**仅接受以下性别组合，按优先级排序：**
- ✅ **真混双(1男1女vs1男1女)** - 真正的混合双打（最高优先级）
- ✅ **男双vs女双(2男2女)** - 男双打女双模式
- ✅ **4男0女** - 男双对战
- ✅ **0男4女** - 女双对战

**严格禁止的组合：**
- ❌ 1男3女 或 3男1女
- ❌ 任何其他不均衡的性别组合

**分组类型说明：**
- **真混双**: 每对都是1男1女搭档，如 (张三♂+小红♀) vs (李四♂+小兰♀)
- **男双vs女双**: 2男2女但男女各自搭档，如 (张三♂+李四♂) vs (小红♀+小兰♀)
- **同性对战**: 4男或4女的同性双打

## 场地利用优化 (v2.1新增)

### 智能场地分配
- **动态场地数调整**：根据可用玩家数量动态调整目标场地数
- **避免空场地**：当可用玩家不足时，减少使用的场地数量
- **补齐阶段优化**：智能分配剩余玩家，优先组成多组以充分利用场地

### 特殊情况处理
**例：4女6男配2片场地**
1. 优先组建：1组混合（2男2女）+ 1组男双（4男0女）
2. 剩余2女继续参与后续分组
3. 避免出现空场地或违规性别组合

### 轮次合并优化
- **智能合并单组轮次**：将分散的单组轮次合并为完整轮次
- **场地利用率提升**：减少场地浪费，提高比赛效率
- **保持分组质量**：合并过程中不违反核心分组规则

## 算法优先级策略

### 第一优先级：真混双（1男1女vs1男1女）
- 真正的混合双打，每对都是异性搭档
- 提供最佳的比赛体验和性别平衡
- 算法优先寻找这种最理想的组合

### 第二优先级：男双vs女双（2男2女）
- 男性组成一对，女性组成一对
- 作为无法组成真混双时的替代方案
- 仍然保持性别数量平衡

### 第三优先级：同性对战
- 4男0女：男子双打对战
- 0男4女：女子双打对战
- 当无法组成混合组合时使用

### 第四优先级：兜底机制
- 仅在前三种策略都无法实现时触发
- 严格遵循性别分组规则
- 确保不会产生违规组合

## 公平性保障

### 比赛机会均等
- 基于历史参赛次数排序，优先安排参赛少的玩家
- 防止某些玩家过度参赛或长期得不到比赛机会

### 搭档多样性
- 严格限制同一搭档组合的次数
- 促进玩家间的交流和不同组合的尝试

### 性别平衡
- 在满足搭档次数限制的前提下，优先考虑性别均衡分组
- 避免性别不平衡导致的比赛质量问题

## 日志记录与监控 (v2.1新增)

### 实时出场次数监控
- **每轮记录**：记录每轮结束后每位玩家的出场次数
- **实时统计**：显示最少、最多、平均出场次数和差距
- **性别标识**：用♂♀符号区分男女玩家，便于观察
- **时间戳记录**：每次记录都包含具体时间信息

### 分组过程日志
- **分组详情**：显示每轮具体的分组情况和性别组合类型
- **场地利用**：实时显示场地使用情况（如：使用2/3片场地）
- **分组类型标识**：
  - 真混双(1男1女vs1男1女) - 显示具体搭档组合
  - 男双vs女双(2男2女但非混双)
  - 男双对战(4男0女) 
  - 女双对战(0男4女)

### 统计分析报告
- **公平性分析**：最终出场次数分布和差距控制评估
- **性别分组统计**：区分真混双、男双vs女双、同性对战的场次统计
- **效率指标**：总轮次、总比赛场次等关键指标
- **轮次优化记录**：显示轮次合并前后的变化

### 日志数据结构
```javascript
// 附加在返回结果中的统计信息
finalSchedule._logs = []; // 详细日志记录
finalSchedule._stats = {
  totalRounds: number,      // 总轮次
  totalMatches: number,     // 总比赛场次
  playCount: {},           // 每人出场次数
  fairnessGap: number,     // 公平性差距
  genderStats: {
    trueMixed: number,       // 真混双场次
    fakeMixed: number,       // 男双vs女双场次
    maleOnly: number,        // 男双对战场次
    femaleOnly: number       // 女双对战场次
  }
};
```

## 版本更新记录

### v2.1 (当前版本)
- **新增**：智能场地分配，避免空场地问题
- **新增**：完整的日志记录和出场次数监控系统
- **新增**：实时统计分析和公平性评估
- **新增**：真混双分组算法（1男1女vs1男1女）
- **优化**：分组优先级，真混双 > 男双vs女双 > 同性对战
- **优化**：补齐阶段分组逻辑，提升场地利用率
- **修复**：4女6男等特殊情况的分组异常
- **改进**：轮次合并算法，减少单组轮次
- **增强**：性别分组策略，确保严格遵循规则
- **增强**：用户体验，提供详细的过程反馈和分组类型识别

### v2.0
- 实现严格的搭档次数限制（最多2次）
- 新增三种标准性别分组模式
- 优化分组优先级策略
- 完善性别平衡算法

### v1.0
- 基础分组功能
- 基本的搭档和轮次管理
- 简单的性别考虑